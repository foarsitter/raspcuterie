<!DOCTYPE html>
<html lang="en" class="has-background-danger">
<head>
    <meta charset="UTF-8">
    <title>Raspcuterie</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma-switch@2.0.0/dist/css/bulma-switch.min.css"
          integrity="sha256-jCV/cXwP13w0GNHLgFx6SFgTNAvJPvS5MIhuE30Ng08=" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://kit.fontawesome.com/3409146a90.js" crossorigin="anonymous"></script>
</head>
<body class="has-background-danger">

<div id="app">
    <div class="is-overlay is-relative is-pulled-right">
        <button>
            <router-link to="/"><i class="fas fa-tachometer"></i></router-link>
        </button>
        <button>
            <router-link to="/bar"><i class="fas fa-cogs"></i></router-link>
        </button>
    </div>
    <router-view></router-view>
</div>

<script type="text/x-template" id="dashboard">
    <section class="section">
        <div class="container">
            <h1 class="title">
                Raspcuterie
            </h1>
            <p class="subtitle">
                Let it <strong>dry</strong>!
            </p>
            <div class="columns">
                <div class="column is-9">
                    <div class="notification is-white">
                        <div id="humidity">
                            <apexchart type="line" height="230" ref="humidity" :options="humidityChartOptions"
                                       :series="humiditySeries"></apexchart>
                        </div>
                        <div id="temperature">
                            <apexchart type="line" height="230" ref="temperature" :options="temperatureChartOptions"
                                       :series="temperatureSeries"></apexchart>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="notification is-white has-text-justified">
                        <div class="level" title="Refrigerator">
                            <div class="level-item">
                                <span class="fa-stack fa-md">
                                    <i class="fas fa-refrigerator fa-lg  fa-stack-1x"></i>
                                    <i v-if="refrigerator" class="fas fa-stack-2x fa-check has-text-success"></i>
                                    <i v-else class="fas fa-stack-2x fa-ban has-text-danger"></i>
                                </span>
                            </div>
                            <div class="level-item" title="Heater">
                                <span class="fa-stack fa-md">
                                    <i class="fas fa-heat fa-lg  fa-stack-1x"></i>
                                    <i v-if="heater" class="fas fa-stack-2x fa-check has-text-success"></i>
                                    <i v-else class="fas fa-stack-2x fa-ban has-text-danger"></i>
                                </span>
                            </div>
                            <div class="level-item" title="Humidifier">
                                <span class="fa-stack fa-md">
                                    <i class="fas fa-shower fa-lg  fa-stack-1x"></i>
                                    <i v-if="humidifier" class="fas fa-stack-2x fa-check has-text-success"></i>
                                    <i v-else class="fas fa-stack-2x fa-ban has-text-danger"></i>
                                </span>
                            </div>
                            <div class="level-item" title="Dehumidifier">
                                <div class="level-item">
                                    <span class="fa-stack fa-md">
                                        <i class="fas fa-air-conditioner fa-lg  fa-stack-1x"></i>
                                        <i v-if="dehumidifier" class="fas fa-stack-2x fa-check has-text-success"></i>
                                        <i v-else class="fas fa-stack-2x fa-ban has-text-danger"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="notification is-primary is-size-1">
                        <div class="level">
                            <div class="level-item"><i class="far fa-thermometer-half fa-2x"></i></div>
                            <div class="level-item">{% if temperature %}{{ temperature|round }}&deg;{% else %}
                                n/a{% endif %}</div>
                        </div>
                    </div>
                    <div class="notification is-primary is-size-1">
                        <div class="level">
                            <div class="level-item"><i class="far fa-humidity fa-2x"></i></div>
                            <div class="level-item">{% if humidity %}{{ humidity|round }}%{% else %}n/a{% endif %}</div>
                        </div>
                    </div>
                    <article class="tile is-child notification is-warning">
                        <div class="field">
                            <input id="refrigerator-switch" type="checkbox"
                                   class="switch is-danger"
                                   checked="checked" v-model="refrigerator" @change="toggleRefrigerator()">
                            <label for="refrigerator-switch">{{ gettext("Refrigerator") }}</label>
                        </div>
                        <div class="field">
                            <input id="heater-switch" type="checkbox"
                                   class="switch is-danger"
                                   checked="checked" v-model="heater"  @change="toggleHeater()">
                            <label for="heater-switch">{{ gettext("Heater") }}</label>
                        </div>

                        <div class="field">
                            <input id="dehumidifier-switch" type="checkbox"
                                   class="switch is-info"
                                   checked="checked" v-model="dehumidifier" @change="toggleDehumidifier()">
                            <label for="dehumidifier-switch">{{ gettext("Dehumidifier") }}</label>
                        </div>
                        <div class="field">
                            <input id="humidifier-switch" type="checkbox"
                                   class="switch is-info"
                                   checked="checked" v-model="humidifier"  @change="toggleHumidifier()">
                            <label for="humidifier-switch">{{ gettext("Humidifier") }}</label>
                        </div>

                    </article>
                </div>
            </div>
        </div>
    </section>
</script>

<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"
        integrity="sha256-FZ8KwMj1F6qnNgA7bhPryVm19xKduH5OVr8u7I1tAtc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-router@3.4.8/dist/vue-router.min.js"
        integrity="sha256-iYFGuwIHs4yzU6E0ypMek6T7y7kx0j47594ktKLiKBA=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.22.0/dist/apexcharts.js"
        integrity="sha256-4Lasz800h6YPi4MMNryQ1EUqRsW+PBE8g2pus4sK5Nw=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-apexcharts@1.6.0/dist/vue-apexcharts.js"
        integrity="sha256-uFIs+Z5USR6iT5utTt+Hx6Du05iEURM/uwwfVsUUvxc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@0.20.0/dist/axios.js"
        integrity="sha256-n7FNwoYsyZMMiu5/NHArDRUq4JFdaZNPz8mE+OMC5VM=" crossorigin="anonymous"></script>
<script>

    function graph(name, _min, _max) {

        return {
            chart: {
                id: name,
                type: 'line',
                group: 'social',
                height: 230,
            },
            title: {
                text: name,
                align: 'left'
            },
            stroke: {
                curve: ['smooth', 'stepline', 'stepline'],
                width: 1,
            },
            tooltip: {
                x: {
                    show: true,
                    format: 'HH:mm',
                },
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    datetimeFormatter: {
                        year: 'yyyy',
                        month: 'MMM \'yy',
                        day: 'dd MMM',
                        hour: 'HH:mm'
                    },
                    datetimeUTC: false
                }
            },
            yaxis: [
                {
                    tickAmount: 2,
                    labels: {
                        minWidth: 40
                    },
                    seriesName: name,
                },
                {
                    opposite: true,
                    seriesName: "Relay",
                    min: 0,
                    max: 3,
                    show: false,
                },
                {
                    seriesName: "Relay",
                    opposite: true,
                    show: false,
                    min: 0,
                    max: 3,
                }
            ]
        }
    }

    Vue.component('apexchart', VueApexCharts)

    const Foo = Vue.component('dashboard', {
            template: '#dashboard',
            components: {
                apexchart: VueApexCharts,
            },

            data() {
                return {
                    refrigerator: {% if refrigerator %}true{% else %}false{% endif %},
                    dehumidifier: {% if dehumidifier %}true{% else %}false{% endif %},
                    humidifier: {% if humidifier %}true{% else %}false{% endif %},
                    heater: {% if heater %}true{% else %}false{% endif %},
                    humiditySeries: [],
                    temperatureSeries: [],
                    humidityChartOptions: graph("{{ gettext("Humidity") }}", {{ humidity_min }}, {{humidity_max}}),
                    temperatureChartOptions: graph("{{ gettext("Temperature") }}", {{ temperature_min }}, {{ temperature_max }}),
                }
            },
            beforeCreate: function () {
                axios({
                    method: 'GET',
                    url: "/api/relay/current.json",
                }).then(function (response) {

                    app.refrigerator = response.data["relay_1"]
                    app.dehumidifier = response.data["relay_2"]
                    app.humidifier = response.data["relay_3"]
                    app.heater = response.data["relay_4"]
                    app.is_loaded = true

                })
            },
            methods: {
                toggleRefrigerator: function () {
                    console.log("refrigerator")

                    const x = this

                    axios({
                        method: 'GET',
                        url: "/api/relay/refrigerator/toggle",
                    }).then(function (response) {
                        console.log(response.data)
                        x.refrigerator = response.data["state"]
                    })
                },
                toggleHumidifier: function () {

                    console.log("humidifier")
                    axios({
                        method: 'GET',
                        url: "/api/relay/humidifier/toggle",
                    }).then(function (response) {

                    })
                },
                toggleDehumidifier: function () {

                    console.log("dehumidifier")
                    axios({
                        method: 'GET',
                        url: "/api/relay/dehumidifier/toggle",
                    })
                },
                toggleHeater: function () {

                    console.log("heater")
                    axios({
                        method: 'GET',
                        url: "/api/relay/heater/toggle",
                    })
                },
                updateChartInterval() {
                    setInterval(() => {
                        this.updateChart()
                    }, 6000 * 60);
                },
                updateChart() {

                    const me = this

                    axios({
                        method: 'GET',
                        url: "/api/am2302/chart.json?period=-7 days&aggregate=3600",
                    }).then(function (response) {
                        me.humiditySeries = response.data["humidity"]
                        me.temperatureSeries = response.data["temperature"]
                    });
                }
            },
            mounted: function () {
                this.updateChart()
                this.updateChartInterval()
            },
        })
    ;
    const Bar = {template: '<div>bar</div>'}

    const routes = [
        {path: '/', component: Foo},
        {path: '/bar', component: Bar}
    ]

    // 3. Create the router instance and pass the `routes` option
    // You can pass in additional options here, but let's
    // keep it simple for now.
    const router = new VueRouter({
        routes, // short for `routes: routes`

    });

    router.currentRoute = routes[0]

    const app = new Vue({
        router
    }).$mount('#app');

</script>
<script src="https://cdn.jsdelivr.net/npm/bulma-extensions@6.2.7/dist/js/bulma-extensions.min.js"
        integrity="sha256-q4zsxO0fpPm6VhtL/9QkCFE5ZkNa0yeUxhmt1VO1ev0=" crossorigin="anonymous"></script>
</body>
</html>